# SSH daemon configuration - managed by Ansible
# Role: security_hardening
# Based on: Mozilla OpenSSH Security Guidelines (Modern-only, OpenSSH 9.0+)
# Reference: https://infosec.mozilla.org/guidelines/openssh

# Host keys (Ed25519 preferred, RSA/ECDSA for compatibility)
HostKey /etc/ssh/ssh_host_ed25519_key
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key

# Cryptography (Post-quantum hybrid KEX, modern ciphers/MACs only)
KexAlgorithms sntrup761x25519-sha512@openssh.com,curve25519-sha256@libssh.org,curve25519-sha256
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com

# Authentication (public key only)
AuthenticationMethods publickey
PubkeyAuthentication yes
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no

# Root login prohibited (Mozilla recommendation)
PermitRootLogin no

# Access control
{% if security_ssh_allowed_users | length > 0 %}
AllowUsers {{ security_ssh_allowed_users | join(' ') }}
{% endif %}

# Logging (verbose for audit trail)
LogLevel VERBOSE
SyslogFacility AUTH

# Connection management
Port {{ security_ssh_port }}
UseDNS no
LoginGraceTime 30s
MaxAuthTries 3
MaxSessions 10
ClientAliveInterval 300
ClientAliveCountMax 2
TCPKeepAlive yes

# Subsystems (with detailed SFTP logging)
Subsystem sftp /usr/libexec/openssh/sftp-server -f AUTHPRIV -l INFO

# Disable unused features
X11Forwarding no
PermitUserEnvironment no

# PAM integration
UsePAM yes
