#!/usr/bin/env bash
set -euo pipefail

# Entry point: ctl <component> <verb> [args]
# Repo-local control plane only.

_this_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
_root_dir="$(cd -- "${_this_dir}/../.." && pwd)"

# --- Global preflight --------------------------------------------------------

# Must run from inside the repo
if [[ ! -f "${_root_dir}/scripts/bin/ctl" ]]; then
  echo "error: ctl must be executed from within the repository" >&2
  exit 1
fi

# Require bash (not sh, not dash)
if [[ -z "${BASH_VERSION:-}" ]]; then
  echo "error: bash is required" >&2
  exit 1
fi

# shellcheck source=../lib/paths.sh
source "${_root_dir}/scripts/lib/paths.sh"
# shellcheck source=../lib/common.sh
source "${_root_dir}/scripts/lib/common.sh"
# shellcheck source=../lib/verbs.sh
source "${_root_dir}/scripts/lib/verbs.sh"

usage() {
  printf "%s\n" \
    "Usage:" \
    "  ctl <component> <verb> [args]" \
    "" \
    "Components:" \
    "  net, app, monitoring, proxy, backup" \
    "" \
    "Verbs:" \
    "  install, uninstall, secrets, secrets-deploy, start, stop, restart, status, check, run"
}

if [[ "${1:-}" == "help" || "${1:-}" == "-h" || "${1:-}" == "--help" || "${#}" -eq 0 ]]; then
  usage
  exit 0
fi

component="${1:-}"; shift || true
verb="${1:-}"; shift || true

[[ -n "${component}" ]] || die "missing component"
[[ -n "${verb}" ]] || die "missing verb"

component_file="${_root_dir}/scripts/components/${component}.sh"
[[ -f "$component_file" ]] || die "unknown component: ${component}"

# Load component spec
# shellcheck source=/dev/null
source "$component_file"

[[ "${component_name:-}" == "${component}" ]] || \
  die "component spec mismatch: expected ${component}, got ${component_name:-<unset>}"

dispatch "$verb" "$@"
