#!/usr/bin/env bash
set -euo pipefail

_root_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"

if [[ ! -f "${_root_dir}/run" ]]; then
  echo "error: run must be executed from within the repository" >&2
  exit 1
fi

if [[ -z "${BASH_VERSION:-}" ]]; then
  echo "error: bash is required" >&2
  exit 1
fi

# Parse and strip --silent flag from arguments
SILENT=false
CLEANED_ARGS=()

for arg in "$@"; do
  if [[ "$arg" == "--silent" ]]; then
    SILENT=true
  else
    CLEANED_ARGS+=("$arg")
  fi
done

export SILENT
set -- "${CLEANED_ARGS[@]}"

source "${_root_dir}/scripts/lib/paths.sh"
source "${_root_dir}/scripts/lib/common.sh"
source "${_root_dir}/scripts/lib/verbs.sh"

usage() {
  local components
  components=$(discover_components | tr '\n' ', ' | sed 's/, $//')
  
  printf "%s\n" \
    "Usage: run <component> <command> [options]" \
    "" \
    "Available components: ${components}" \
    "Run 'run <component> help' for component-specific commands"
}

if [[ "${1:-}" == "help" || "${1:-}" == "-h" || "${1:-}" == "--help" || "${#}" -eq 0 ]]; then
  usage
  exit 0
fi

readonly COMPONENT="${1:-}"
readonly VERB="${2:-help}"
shift 2 || true

[[ -n "${COMPONENT}" ]] || die "missing component"

component_file="${_root_dir}/scripts/components/${COMPONENT}.sh"
[[ -f "$component_file" ]] || die "unknown component: ${COMPONENT}"

source "$component_file"

dispatch "$@"
